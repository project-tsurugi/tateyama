# service message compatibility 方針

* 2023-11-21 arakawa (NT) - 初版

## この文書について

* Tsubakuro - Tateyama 間のメッセージングにおいて、各サービスの service message version をどのように決めるかについての指針

## 用語集

* サーバー
  * Tsurugidb のインスタンス
* クライアント
  * Tsubakuro を利用してサーバーと通信を行うアプリケーション
* サービス
  * サーバー上で稼働し、クライアントからのリクエストを受け付けているコンポーネント (e.g. SQL実行エンジン)
* サービスクライアント
  * 特定のサービスに対し、クライアントから通信するためのライブラリ
* service message version (SMV)
  * サービスとサービスクライアント間でやり取りされるメッセージのバージョン

## 基本的なデザイン

* SMV はサービスごとに付与する
* サービスクライアントは、対象のサービスと同一の SMV を付与する
* SMV は major, minor の2パートに分かれる
* サービスとサービスクライアントは同一の major SMV を有する場合のみ、かつその場合に限り、メッセージ交換ができる
  * major SMV の変更は **メッセージの breaking change** を表す
  * 逆に言えば、 minor SMV を変えてもメッセージ交換の是非については影響がない
* major SMV を変更する際、クライアント・サーバーともに後方互換性は考慮しない
  * major SMV が異なったら即座にエラーとなるので、後方互換性を仕込んでも意味がない
  * 後方互換性を担保する場合、 **minor SMV を変更する** ようにする
* SMV が未定義の場合、バージョン `0.0` として扱う
  * protocol buffers の定義上、未定義のものを `0` として扱うと都合がよい
  * つまり、SMVを変更する際には `0.0` を基点に行う
* major SMV は変更のたびに原則 1 ずつ増加させ、増加の際には minor を 0 に設定する
* minor SMV は変更のたびに原則 1 ずつ増加させる

## メッセージの構造

* リクエストエンベロープ
  * サービスクライアントが送付する、一番外側のメッセージ
* リクエストアイテム
  * リクエストエンベロープに含まれる、特定のリクエストに対応するメッセージ
* 必須リクエストフィールド (mandatory)
  * リクエストエンベロープまたはリクエストアイテムに含まれるフィールドのうち、実行に必須の項目
* 任意リクエストフィールド (optional)
  * リクエストエンベロープまたはリクエストアイテムに含まれるフィールドのうち、無視されても実行に大きな影響がない項目
* レスポンスアイテム
  * リクエストに対するレスポンスメッセージ
* 必須レスポンスフィールド (mandatory)
  * レスポンスアイテムに含まれるフィールドのうち、結果に必要の項目
* 任意レスポンスフィールド (optional)
  * レスポンスアイテムに含まれるフィールドのうち、無視されても結果に大きな影響がない項目
* service message version フィールド
  * リクエストエンベロープ上のフィールドで、service message version の情報を付与したフィールド (群)

備考:

* レスポンスエンベロープはレスポンスアイテムと同一視しても問題ないため、上記では省略している

## メッセージの変更とバージョニング

表記: _xxx_ &lt; _yyy_ -> 「_xxx_ は _yyy_ より SMV が古い」

* (a) リクエストエンベロープの定義変更 (ERROR)
  * リクエストエンベロープのメッセージ種を、 **別のメッセージ種に変更してはならない**
  * サービス側でリクエストエンベロープを展開できず、それに含まれる SMV も取り出せない
* (b) リクエストのリクエストアイテムの変更 (MAJOR)
  * あるリクエストの、リクエストアイテムをメッセージ種 a から別の a' に変更する場合、 **MAJOR** SMV を変更する
  * client &lt; server
    * サービスは a' を期待するが、旧式の a が届く
  * server &lt; client
    * サービスは a を期待するが、未知の a' が届く
* (c) 新しいリクエストの追加 (リクエストアイテムの追加) (MAJOR)
  * 新しいリクエストの、リクエストアイテム種 a を追加する場合、 **MAJOR** SMV を変更する
  * client &lt; server
    * サービスに新しいリクエスト a に届かないので問題ない
  * server &lt; client
    * サービスにとって未知のリクエスト a が届く
* (c') 既存のリクエストの削除 (リクエストアイテムの削除) (MAJOR)
  * 既存のリクエストの、リクエストアイテム種 a を削除する場合、 **MAJOR** SMV を変更する
  * client &lt; server
    * サービスに削除済みのリクエスト a が届く (未知のリクエストと同様)
  * server &lt; client
    * サービスはリクエスト a を処理可能だが、クライアントはそのようなリクエストを送ってこない
* (d) 必須リクエストフィールドの追加 (MAJOR)
  * あるリクエストのリクエストアイテムに、新たな _必須 (mandatory)_ フィールド f を追加する場合、 **MAJOR** SMV を変更する
  * client &lt; server
    * サービスに届くリクエストの新しいフィールド f には既定値が格納されており、実行に必須の情報が欠けている
  * server &lt; client
    * サービスはリクエストに含まれる未知のフィールド f を読み飛ばし、呼び出し元の要求を反映しない
* (d') 必須リクエストフィールドの削除 (MAJOR)
  * あるリクエストのリクエストアイテムから、既存の必須フィールド f を削除する場合、 **MAJOR** SMV を変更する
  * client &lt; server
    * サービスに削除済みのフィールド f が届くが、読み飛ばされる
  * server &lt; client
    * サービスは必須フィールド f の内容を取得できず、実行に必須の情報が欠けている
* (e) 任意リクエストフィールドの追加 (minor)
  * あるリクエストのリクエストアイテムに、新たな _任意 (optional)_ フィールド f を追加する場合、 **minor** SMV を変更する
  * client &lt; server
    * サービスに届くリクエストの新しいフィールド f には既定値が格納されているが、任意フィールドなので処理を継続できる
  * server &lt; client
    * サービスはリクエストに含まれる未知のフィールド f を読み飛ばすが、任意フィールドなので処理を継続できる
* (e') 任意リクエストフィールドの削除 (minor)
  * あるリクエストのリクエストアイテムから、既存の任意フィールド f を削除する場合、 **minor** SMV を変更する
  * client &lt; server
    * サービスに削除済みのフィールド f が届くが、読み飛ばされる
  * server &lt; client
    * サービスは任意フィールド f の内容を取得できず、既定値を利用して処理を続行する
* (f) レスポンスアイテムの定義変更 (MAJOR)
  * あるリクエストに対する、レスポンスアイテムのメッセージ種を a から別の a' に変更する場合、 **MAJOR** SMV を変更する
  * client &lt; server
    * クライアントは a を期待するが、未知の a が届く
  * server &lt; client
    * クライアントは a' を期待するが、旧式の a' が届く
* (g) 必須レスポンスフィールドの追加 (MAJOR)
  * あるレスポンスアイテムに、新たな _必須 (mandatory)_ フィールド f を追加する場合、 **MAJOR** SMV を変更する
  * client &lt; server
    * クライアントは届いたレスポンスアイテムの f を読み飛ばし、処理に必須の情報を読み取れない
  * server &lt; client
    * クライアントに届いたレスポンスアイテムの f には既定値が格納されており、実行に必須の情報が欠けている
* (g') 必須レスポンスフィールドの削除 (MAJOR)
  * あるレスポンスアイテムから、既存の必須フィールド f を削除する場合、 **MAJOR** SMV を変更する
  * client &lt; server
    * クライアントは届いたレスポンスアイテムの f には既定値が格納されており、実行に必須の情報が欠けている
  * server &lt; client
    * クライアントは届いたレスポンスアイテムの f を読み飛ばし、処理に必須の情報を読み取れない
* (h) 任意レスポンスフィールドの追加 (minor)
  * あるレスポンスアイテムに、新たな _任意 (optional)_ フィールド f を追加する場合、 **minor** SMV を変更する
  * client &lt; server
    * クライアントは届いたレスポンスアイテムの f を読み飛ばすが、任意フィールドなので処理を継続できる
  * server &lt; client
    * クライアントに届いたレスポンスアイテムの f には既定値が格納されているが、任意フィールドなので処理を継続できる
* (h') 任意レスポンスフィールドの削除 (minor)
  * あるレスポンスアイテムから、既存の任意フィールド f を削除する場合、 **minor** SMV を変更する
  * client &lt; server
    * クライアントに届いたレスポンスアイテムの f には既定値が格納されているが、任意フィールドなので処理を継続できる
  * server &lt; client
    * クライアントは届いたレスポンスアイテムの f を読み飛ばすが、任意フィールドなので処理を継続できる

## 後方互換性

* 各サービスは、メッセージの後方互換性を保つことで、複数の major SMV を受け付けてもよい (optional)
  * サーバーの後方互換性とは、つまり major SMV が client &lt; server となっている際に、エラーとしない処置である
  * server &lt; client の場合は基本的に考慮しない
* [メッセージの変更とバージョニング](#メッセージの変更とバージョニング) において、以下の方法で後方互換性を保てる
  * (a) リクエストエンベロープの定義変更
    * 対処が困難
  * (b) リクエストのリクエストアイテムの変更
    * あるリクエストの、リクエストアイテムをメッセージ種 a から別の a' に変更する場合、サーバーは a と a' の両者を受け入れることで、後方互換性を保てる
  * (c) 新しいリクエストの追加 (リクエストアイテムの追加)
    * 新しいリクエストの、リクエストアイテム種 a を追加する場合、自動的に後方互換性が保たれている
  * (c') 既存のリクエストの削除 (リクエストアイテムの削除)
    * 古いリクエストの、リクエストアイテム種 a を以降も利用可能にしておけば、後方互換性を保てる
  * (d) 必須リクエストフィールドの追加
    * あるリクエストのリクエストアイテムに、新たな必須フィールド f を追加する場合、SMV が異なる場合の f の既定値を定めておくことで後方互換性を保てる
  * (d') 必須リクエストフィールドの削除
    * フィールドの定義を削除せず、クライアントが以降も (サービスにとって) 適切な値を設定し続ければ後方互換性を保てる
  * (e) 任意リクエストフィールドの追加
    * minor SMV の変更なので問題ない
  * (e') 任意リクエストフィールドの削除 (minor)
    * minor SMV の変更なので問題ない
  * (f) レスポンスアイテムの定義変更
    * あるリクエストに対する、レスポンスアイテムのメッセージ種を a から別の a' に変更する場合、クライアントから送られた SMV に応じて a か a' を切り替えて送付することで後方互換性を保てる
  * (g) 必須レスポンスフィールドの追加
    * あるレスポンスアイテムに、新たな必須フィールド f を追加する場合、基本的に後方互換性を保つのは困難
      * クライアントが読み込まなくていい場合、それは任意フィールドである
  * (g') 必須レスポンスフィールドの削除
    * フィールドの定義を削除せず、サービスが以降も (クライアントにとって) 適切な値を設定し続ければ後方互換性を保てる
  * (h) 任意レスポンスフィールドの追加
    * minor SMV の変更なので問題ない
  * (h') 任意レスポンスフィールドの削除
    * minor SMV の変更なので問題ない
* ただし、 SMV u から v に変更したうえで後方互換性を保つには、 u から v への変更のすべての内容について上記を行う必要がある
